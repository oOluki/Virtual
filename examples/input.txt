%include "vstd/vstdio.in"


;; reads up to RB.as_u64 bytes from stdin to RA.as_ptr up to the next new line, returns the number of characters read through RA.u64
read_line:
    ;; read byte
    PUSH RD
    ;; position
    PUSH RE
    PUSH RF
    PUSH RX
    PUSH RY
    
    XOR RD RD RD
    XOR RE RE RE
    MOVV RF '\n'

    loop:
        GETCHAR RD R0
        WRITE8 RA RD RE
        INC  RE 1
        SMLI RX RD R0
        EQ   RY RD RF
        OR   RX RX RY
    JMPFN RX @loop

    MOV RA RE

    POP RY
    POP RX
    POP RF
    POP RE
    POP RD
    RET
%unlabel loop


%start

STATIC "Enter message:\n"
POP RB
CALL @dump_str


MOVV RA 8
GSP RA RA R0
INC RSP 108

MOV RX RA

CALL @read_line
DEC RA 1
MOVV RB '\0'
WRITE8 RX RB RA

MOVV RA 0

STATIC "You said: \'"
POP RB
CALL @dump_str

MOV RB RX
CALL @dump_str

STATIC "\'\n"
POP RB
CALL @dump_str
